packages:
  yum:
    certbot: []
    mod_ssl: []
    nginx-mod-stream: []

files:
  /home/ec2-user/setup.sh:
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      export EMAIL=$(/opt/elasticbeanstalk/bin/get-config environment -k EMAIL)
      export DOMAIN=$(/opt/elasticbeanstalk/bin/get-config environment -k DOMAIN)
      aws s3 cp s3://media-teltonika/privkey.pem /etc/letsencrypt/live/$DOMAIN/privkey.pem
      aws s3 cp s3://media-teltonika/fullchain.pem /etc/letsencrypt/live/$DOMAIN/fullchain.pem
      service nginx stop
      sudo certbot certonly --non-interactive --email $EMAIL --agree-tos --standalone --domains $DOMAIN --force-renewal
      service nginx start
      cp -v /etc/letsencrypt/live/$DOMAIN/fullchain.pem /var/app/staging/setup/fullchain.pem
      aws s3 cp /etc/letsencrypt/live/$DOMAIN/fullchain.pem s3://media-teltonika/fullchain.pem
      cp -v /etc/letsencrypt/live/$DOMAIN/privkey.pem /var/app/staging/setup/privkey.pem
      aws s3 cp /etc/letsencrypt/live/$DOMAIN/privkey.pem s3://media-teltonika/privkey.pem

container_commands:
  getcert:
    command: /home/ec2-user/setup.sh
    ignoreErrors: true
